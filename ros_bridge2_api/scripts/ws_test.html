<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Robot Status WebSocket Stream</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        #output { white-space: pre; background: #f4f4f4; padding: 1em; border-radius: 5px; }
        label, select, button { font-size: 1em; margin-right: 1em; }
    </style>
</head>
<body>
    <center><h2>Robot Status WebSocket Stream</h2></center>
    <div style="display: flex; gap: 2em;">
        <div style="flex:1; border: 1px solid #aaa; border-radius: 8px; padding: 1em;">
            <h3>robot_01</h3>
            <div id="robot_01_status">
                <div>robot_battery_percentage: <span id="robot_01_battery"></span> <span id="robot_01_battery_time" style="color:#888;font-size:0.9em;"></span></div>
                <div>robot_controller_mode_status: <span id="robot_01_mode"></span> <span id="robot_01_mode_time" style="color:#888;font-size:0.9em;"></span></div>
                <div>robot_current_station: <span id="robot_01_station"></span> <span id="robot_01_station_time" style="color:#888;font-size:0.9em;"></span></div>
                <div>robot_navigation_status: <span id="robot_01_nav"></span> <span id="robot_01_nav_time" style="color:#888;font-size:0.9em;"></span></div>
                </div>
                <div id="robot_01_time" style="font-size:0.95em;color:#888;"></div>
            <div style="margin:1em 0;">
                <button style="background:#d32f2f;color:white;" onclick="cancelNavigation('robot_01')">Cancel Navigation</button>
                <button style="background:#ff9800;color:white;" onclick="pauseNavigation('robot_01')">Pause Navigation</button>
                <button style="background:#388e3c;color:white;" onclick="resumeNavigation('robot_01')">Resume Navigation</button>
            </div>
            <div id="robot_01_conn" style="font-size:0.9em;color:#888;"></div>
            <div id="robot_01_time" style="font-size:0.95em;color:#888;"></div>
            <div id="robot_01_nav_result" style="font-size:0.95em;color:#006400;"></div>
        </div>
        <div style="flex:1; border: 1px solid #aaa; border-radius: 8px; padding: 1em;">
            <h3>robot_02</h3>
            <div id="robot_02_status">
                <div>robot_battery_percentage: <span id="robot_02_battery"></span> <span id="robot_02_battery_time" style="color:#888;font-size:0.9em;"></span></div>
                <div>robot_controller_mode_status: <span id="robot_02_mode"></span> <span id="robot_02_mode_time" style="color:#888;font-size:0.9em;"></span></div>
                <div>robot_current_station: <span id="robot_02_station"></span> <span id="robot_02_station_time" style="color:#888;font-size:0.9em;"></span></div>
                <div>robot_navigation_status: <span id="robot_02_nav"></span> <span id="robot_02_nav_time" style="color:#888;font-size:0.9em;"></span></div>
                </div>
                <div id="robot_02_time" style="font-size:0.95em;color:#888;"></div>
            <div style="margin:1em 0;">
                <button style="background:#d32f2f;color:white;" onclick="cancelNavigation('robot_02')">Cancel Navigation</button>
                <button style="background:#ff9800;color:white;" onclick="pauseNavigation('robot_02')">Pause Navigation</button>
                <button style="background:#388e3c;color:white;" onclick="resumeNavigation('robot_02')">Resume Navigation</button>
            </div>
            <div id="robot_02_conn" style="font-size:0.9em;color:#888;"></div>
            <div id="robot_02_time" style="font-size:0.95em;color:#888;"></div>
            <div id="robot_02_nav_result" style="font-size:0.95em;color:#006400;"></div>
        </div>
    </div>
    <script>
        // Navigation control button handlers (call FastAPI endpoints)
        function cancelNavigation(robot) {
            navAction(robot, 'cancel_navigation');
        }
        function pauseNavigation(robot) {
            navAction(robot, 'pause_navigation');
        }
        function resumeNavigation(robot) {
            navAction(robot, 'resume_navigation');
        }

        function navAction(robot, action) {
            let host = location.hostname;
            if (!host) host = 'localhost';
            const url = `http://${host}:8000/robot/${robot}/${action}`;
            document.getElementById(`${robot}_nav_result`).textContent = 'Sending...';
            fetch(url, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById(`${robot}_nav_result`).textContent = `${action.replace('_', ' ').toUpperCase()}: SUCCESS - ${data.message || ''}`;
                        document.getElementById(`${robot}_nav_result`).style.color = '#006400';
                    } else {
                        document.getElementById(`${robot}_nav_result`).textContent = `${action.replace('_', ' ').toUpperCase()}: FAILED - ${data.error || data.message || ''}`;
                        document.getElementById(`${robot}_nav_result`).style.color = '#d32f2f';
                    }
                })
                .catch(err => {
                    document.getElementById(`${robot}_nav_result`).textContent = `${action.replace('_', ' ').toUpperCase()}: ERROR - ${err}`;
                    document.getElementById(`${robot}_nav_result`).style.color = '#d32f2f';
                });
        }
    </script>
    <br>
    <div style="max-width: 500px; margin: 2em auto; border: 1px solid #aaa; border-radius: 8px; padding: 1em;">
        <h3>Assign Task</h3>
        <form id="assignTaskForm" onsubmit="assignTask(event)">
            <label for="task_type_id">Task Type ID:</label>
            <input type="number" id="task_type_id" min="1" max="4" required placeholder="1-4"><br><br>
            <label for="pallet_id">Pallet ID:</label>
            <input type="text" id="pallet_id" required><br><br>
            <label for="task_id">Task ID:</label>
            <input type="text" id="task_id" required><br><br>
            <button type="submit">Assign Task</button>
        </form>
        <div id="assign_result" style="margin-top:1em;color:#006400;"></div>
    </div>
    <script>
        // Assign Task logic
        function assignTask(event) {
            event.preventDefault();
            const task_type_id = document.getElementById('task_type_id').value;
            const pallet_id = document.getElementById('pallet_id').value;
            const task_id = document.getElementById('task_id').value;
            let host = location.hostname;
            if (!host) host = 'localhost';
            // POST to /assigntask/{task_type_id}/{pallet_id}/{task_id}
            const url = `http://${host}:8000/assigntask/${task_type_id}/${pallet_id}/${task_id}`;
            fetch(url, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('assign_result').textContent = JSON.stringify(data, null, 2);
                })
                .catch(err => {
                    document.getElementById('assign_result').textContent = 'Error: ' + err;
                });
        }

        // Map topic to span id for each robot
        const topicMap = {
            robot_battery_percentage: 'battery',
            robot_controller_mode_status: 'mode',
            robot_current_station: 'station',
            robot_navigation_status: 'nav',
        };
        // Store websockets for each robot
        const wsClients = {};
        function connectRobot(robot) {
            let host = location.hostname;
            if (!host) host = 'localhost';
            const url = `ws://${host}:8000/ws/${robot}`;
            const ws = new WebSocket(url);
            wsClients[robot] = ws;
            document.getElementById(`${robot}_conn`).textContent = 'Connecting...';
            ws.onopen = () => {
                document.getElementById(`${robot}_conn`).textContent = 'Connected';
            };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                const el = document.getElementById(`${robot}_${topicMap[data.topic]}`);
                if (el) el.textContent = data.value;
                    // Update single last update time for the robot
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString();
                    document.getElementById(`${robot}_time`).textContent = `Last update: ${timeStr}`;
            };
            ws.onclose = () => {
                document.getElementById(`${robot}_conn`).textContent = 'Disconnected';
            };
            ws.onerror = (e) => {
                document.getElementById(`${robot}_conn`).textContent = 'Error';
            };
        }
        // Auto-connect on page load
        window.onload = function() {
            connectRobot('robot_01');
            connectRobot('robot_02');
        };
    </script>
</body>
</html>
